# Lecture 02

A brief introduction to Linux Programming: vim+gcc+ld+gdb

---

## 使用 Vim 编辑程序

[Vim](https://www.vim.org/) 是一个类似于 Vi 的著名的功能强大、高度可定制的文本编辑器，在 Vi 的基础上改进和增加了很多特性。
Vim 是自由软件， Windows 系统上可使用 GVim 。
它的最大特色是完全使用键盘命令进行编辑，脱离了鼠标操作虽然使得入门变得困难，但上手之后键盘流的各种巧妙组合操作却能带来极为大幅的效率提升。
因此 Vim 和现代的编辑器（如 Sublime Text）有着非常巨大的差异，而且入门学习曲线陡峭，需要记住很多按键组合和命令。 
Vim 拥有众多的插件可供选择，代码补全、语法高亮、配色方案、自动纠错、编译及错误跳转等方便编程的功能特别丰富，在程序员中被广泛使用，和 Emacs 并列成为类 Unix 系统用户最喜欢的文本编辑器。
Vim 的主要开发者是Bram Moolenarr ，现在我们每次启动 Vim 时，封面上会随机选择一种提示语展示(共有三种，如"帮助乌干达的可怜儿童!")。

vimtutor是个很好用的教程，对初学者非常友好，要使用它可在终端输入以下命令，然后在里面按提示操作即可(不用担心会破坏文件):

	```
	vimtutor
	```

网上有人做了个 Vim 的游戏：[Game](https://vim-adventures.com/)。

### 启动和退出

默认启动 Vim 可用 `vim` 命令，启动后会显示 Vim 的首页，此时未打开任何文件。
用 `vim --noplugin` 可不带任何插件启动 Vim ，但 Vim的配置信息仍然是被加载的。

用 `vim -d` 或 `vimdiff` 命令可对两个文件进行比较和编辑，对比算法采用的是 LCS(Longest Common Subsequence)。

如果要打开多个文件，可以用 `vim file1 file2` 命令(文件数目可以大于两个，下同)，打开后可用 `:n` 和 `:N` 命令在各文件间跳转。
我们时常希望在各文件间进行一些剪切、复制和粘贴的操作，因此更推荐的一种方法是使用分割或者标签页。
用 `vim -o file1 file2` 命令对 file1 和 file2 上下分割，用 `vim -O file1 file2` 命令对 file1 和 file2 左右分割。
用 `vim -p file1 file2` 命令可将多个文件各自在标签页中打开，标签页间的跳转可用 `gt` 或者 `:n` 和 `:N` 命令。

**Ctrl-S是锁屏操作， Vim 中请不要用这个命令来保存文件。**

退出 Vim 请先回到命令模式(注意不要在插入模式下尝试退出)，然后输入 `:q` 命令即可退出。
如果打开了文件且文件发生修改，则需使用 `:wq` 或 `Shift+zz` 命令保存并退出，或者使用 `:q!` 强制退出(不保存文件)。
如果打开了多个文件，可以逐个退出(即先退出一个文件，再退出另一个……)，也可以使用 `:wqa` 或 `:qa!` 命令一次性退出。


### 模式转换

Vim 有以下几种模式：

- 正常（normal）模式，缺省的编辑模式；下面如果不加特殊说明，提到的命令都直接在正常模式下输入；任何其它模式中都可以通过键盘上的 Esc 键回到正常模式。
- 命令（command）模式，用于执行较长、较复杂的命令；在正常模式下输入“:”（一般命令）、“/”（正向搜索）或“?”（反向搜索）即可进入该模式；命令模式下的命令要输入回车键（Enter）才算完成。
- 插入（insert）模式，输入文本时使用；在正常模式下键入“i”（insert）或“a”（append）即可进入插入模式（也有另外一些命令，如“c”，也可以进入插入模式，但这些命令有其它的作用）。
- 替换（Replace）模式，按R键进入，和插入模式的不同之处在于替换模式下的编辑会直接覆盖文本。
- 可视（visual）模式，用于选定文本块；可以在正常模式下输入“v”（小写）来按字符选定，输入“V”（大写）来按行选定，或输入“Ctrl-V”来按方块选定。

![Vim modes](mode.png)

**尽量在命令模式下操作，包括对文件的编辑！每当完成一个操作，要及时回到命令模式！**

敲下 `<ESC>` 键可以回到命令模式，或者使用 `CTRL-[` 组合命令，使用 `CTRL-O` 命令可以临时回到命令模式(然后你可以做一个操作如移动光标，之后会自动进入插入模式)。

打开文件时默认处于命令模式，要进入插入模式可用以下方法：

- i 在当前光标所在字符的前面，转为输入模式
- I  在当前光标所在行的行首，转换为输入模式
- a 在当前光标所在字符的后面，转为输入模式
- A 在当前光标所在行的行尾，转换为输入模式
- o 在当前光标所在行的下方，新建一行，并转为输入模式
- O 在当前光标所在行的上方，新建一行，并转为输入模式

### 快速移动

由于历史原因(或者确实有些道理)，Vim 选择`hjkl`作为方向键，分别表示左、下、上、右。
使用键盘上默认的方向键也是可以的，不过建议使用上面这种方式，因为不同键盘上方向键位置不固定，有些可能离主区域较远，来回移动比较麻烦。

**注意`hjkl`作为方向键不能在插入模式和替换模式下使用，但方向键可以。**

以下是一些常用的移动命令：

- 3j  向下移动3行，可换成其他数字（下同）
- 3k  向上移动3行
- 3h  向左移动3位
- 3l  向右移动3位
- gj 如果一行太长占用多个显示行，可用该命令向下移动一个显示行
- gk 如果一行太长占用多个显示行，可用该命令向上移动一个显示行
- Ctrl-U 内容下移半屏幕
- Ctrl-D 内容上移半屏幕
- Ctrl-f 内容向下移一屏幕
- Ctrl-b 内容上移一屏幕
- Ctrl-e 内容上移一行
- Ctrl-y 内容下移一行
- $ 移动光标到行尾
- 0 移动光标到行首
- ^ 移动光标到行首第一个非空格或tab的地方
- w 光标移到下一个单词的起始
- b 光标移到当前单词的起始
- e 光标移到当前单词的结尾
- 15G 定位到文件的第十五行
- gg 定位到文件的起始
- Shift+G 定位到文件的结尾
- Shift+H 光标移到当前屏幕的顶部
- Shift+M 光标移到当前屏幕的中间
- Shift+L 光标移到当前屏幕的底部
- gg=G 自动缩进整个文件
- % 光标移动到匹配的括号处
- `. 光标移动到上次编辑的位置
- zz 让光标所在的行居屏幕中央
- zt 让光标所在的行居屏幕最上一行
- zb 让光标所杂的行居屏幕最下一行

### 命令模式下的编辑

这里只介绍最基本的命令，

- x 删除一个字符
- r 替换一个字符，下一个输入的字符为替换后的字符
- cc 删除一行并进入插入模式，光标置于行首
- dd 删除整行
- d$ 删除光标所在字符到行尾的全部内容
- dG 删除当前行到文件末尾的所有行

### 复制和粘贴

复制和粘贴都是文本编辑中常用的操作，编程时更是如此，下面将介绍一些最常用的命令：

- yy 复制当前行的内容到剪贴板
- p 将剪贴板中内容粘贴在当前行的下方
- P 将剪贴板中内容粘贴在当前行的上方
- 10p 将剪贴板中的内容在当前行的下方连续粘贴十次

### 撤销和重做

Vim 中允许取消上一步的编辑，也允许重做上一步的编辑操作（即取消`u`的效果）。

- u 取消上一步的编辑操作

- ctrl-R 重做上一次的编辑操作，即取消`u`的效果

- . 将之前的编辑操作在当前的位置再次应用


### 拓展（不讲）

#### 选中和编辑

选中后可以上下左右移动，确定选中区域后可做其他编辑操作，如在连续十行代码的开头都插入某些字符。

- v 选中当前字符
- V 选中整行
- Ctrl-v 块选择，若干列若干行组成的矩阵

#### 搜索与替换

可以用到的时候再查：

- n,N 下一个，上一个
- /^text$
- /text\$\c
- ?text  反向搜索
- :%s/xxx/yyy/g  全文搜索与替换
- :s/xxx/yyy/g 当前行全部替换
- :s/xxx/yyy  当前行替换第一次
- :s/xxx/yyy/c
- :s/xxx/yyy/i
- :.,+2s/xxx/yyy/g
- :3,5s/xxx/yyy/g 第三行到第五行的区域内搜索并全部替换

#### 标记与跳转

标记是 Vim 中一个非常实用的功能，Vim 甚至可以在不同文件内标记与跳转：

- ma 在当前位置设置文件内的标签a
- mA 在当前位置设置全局的标签A
- 'a 跳转到标记a的位置的行首
- `a 跳转到具体标记的那个位置

#### 其他

- shift+j 合并两行
- ctrl-z  临时退出 Vim 回到终端
- fg 从终端回到先前的 Vim 界面

多重剪贴板通过寄存器实现：regs

- "3yy 将当前行的内容复制到3号寄存器
- "3p 将3号寄存器的内容粘贴到当前行的下方

插入模式下如何移动？ 最好就不要在插入模式下移动！

- 可以选择方向键
- 或者重映射快捷键
- 使用`Ctrl-O`临时进入正常模式

将系统剪切板的内容粘贴到 Vim 后格式会乱掉：
- `:set paste` 设置为粘贴模式

在 Vim 中输入中文的问题？  

- 在 Linux 上 Vim 处于 Normal 模式时就禁用中文输入法（如fcitx）

Vim 的配置文件

- .vimrc 用户的 Vim 配置文件
- .vim/  用户的 Vim 配置目录，可以放置插件等等

vim 的各种加强版本如 neovim， exvim 等等

vim 的各种插件(一般用 VimL 语言编写，来自官网或 GitHub)，如taglist YouCompleteMe Vundle插件管理器 等等

书籍  Practical Vim 介绍了各种 Vim 技巧

![vim operations](vim.png)

---

## 使用 GCC 编译程序

### C99 标准

C99 是继C89之后的第二个C语言官方标准，增加了很多新特性，其中一些如下：

- 增加了long long int和unsigned long long int类型
- 变量声明不必放在语句块的开头，比如可以直接在for循环中声明循环变量
- 预编译处理增强了，比如支持了可变参数的宏
- 对编译器限制增加了，比如源程序中要求至少支持到4095字节，变量名和函数名的要求至少支持到63字节（extern要求支持到31）

在老版本的GCC里面，比如gcc 4.8.2中，要使编译时按照C99的规范，应该加入`-std=c99`选项。

![C versions](cversion.png)

### 编译选项

一些常用的编译选项列举如下：

- -g  
- -L 
- -I 
- -l 
- -D

### 编译过程

详细介绍编译的四个阶段，可以将每个阶段的中间输出展示给大家

预处理

编译

汇编

链接

### 拓展提高 

C11和C14

优化选项

O0 O1 O2 O3 Os

发行时一般用 O2 或 O3 ，O3选项据称有一定风险

---

## Linux 上程序的运行

```
./example.exe > ans.txt
```

复杂的编译命令可写在 Makefile 中

### 环境变量

man ld.so

LD_LIBRARY_PATH

PATH

### Linux 上的运行库

https://blog.csdn.net/u010977122/article/details/52958330

file example.exe

nm example.exe

ldd example.exe

类似 Windows 上的 dll ，库依赖很容易导致问题(比如不同的库版本)

静态库与动态库

/etc/ld.so.conf

### 拓展提高

链接、装载与库

---

## 使用 GDB 来调试

https://blog.csdn.net/u013525455/article/details/52813637

用 gcc -g 编译并取消优化选项

### 启动和退出

```
gdb ./example.exe
quit
Ctrl-D
```


### 基本使用

#### 用 list 列出源代码

list

help list

list 10

list addResult

list 10,15

list list.h:15

list list.h:addResult

#### 运行程序

run

run arg

#### 使用断点

break 7

break addResult

break list.h:15

break list.h:addResult

info break

break 8 if a == 10

disable 断点号

enable 断点号

disable once 断点号

enable once  断点号

enable delete  断点号

delete 断点号

clear

#### 流程控制

continue

next

step

kill

#### 监控变量

print &a

### 拓展（不讲）

#### visual studio 2017 远程调试功能

需要安装`gdbserver`, 使用方法参考 [HELP](https://www.cnblogs.com/xylc/p/6533716.html?&from=androidqq)。

#### GDB 调试多线程与多进程

#### Unix 环境高级编程

---

